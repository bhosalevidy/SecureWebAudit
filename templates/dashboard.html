<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Automation Test Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Poppins',sans-serif; background:#0f172a; color:#fff; margin:0; padding:0; }

    .main-header { display:flex; justify-content:space-between; align-items:center; padding:1rem 2.5rem; position:fixed; top:0; width:100%; z-index:1000; background: rgba(15,23,42,0.9); backdrop-filter: blur(12px); border-bottom:1px solid rgba(0,255,255,0.2); flex-wrap:wrap; }
    .logo { display:flex; align-items:center; gap:10px; }
    .site-title { font-size:1.6rem; font-weight:700; color:#00ffff; letter-spacing:1px; cursor:pointer; }
    .nav-links { display:flex; gap:1.8rem; flex-wrap: wrap; }
    .nav-links a { color:#e5e5e5; text-decoration:none; font-weight:500; position:relative; padding-bottom:5px; }
    .nav-links a::after { content:""; position:absolute; width:0%; height:3px; left:0; bottom:0; background: linear-gradient(90deg,#00ffff,#38bdf8); border-radius:2px; transition: width 0.3s ease; }
    .nav-links a:hover { color:#00ffff; }
    .nav-links a:hover::after { width:100%; }
    .login-btn { background: linear-gradient(135deg,#00ffff,#38bdf8); color:#000; padding:0.6rem 1.3rem; border-radius:30px; font-weight:600; text-decoration:none; transition:all 0.3s ease; box-shadow:0 0 12px rgba(0,255,255,0.3); flex-shrink:0; }
    .login-btn:hover { background: linear-gradient(135deg,#38bdf8,#00ffff); box-shadow:0 0 20px #00ffff,0 0 40px #00ffff; }

    .page-heading { margin-top:100px; margin-bottom:30px; font-size:2rem; font-weight:600; color:#00ffff; text-align:center; letter-spacing:1px; }

    .container { width:95%; margin:auto; padding:2rem; }
    .top-buttons { display:flex; justify-content:flex-end; margin-bottom:1rem; gap:1rem; }
    .btn { padding:0.5rem 1rem; background:#38bdf8; color:#0f172a; font-weight:bold; border:none; border-radius:8px; cursor:pointer; transition:0.3s; }
    .btn:hover { background:#0ea5e9; }

    .summary { display:flex; justify-content:space-between; gap:1.5rem; margin-bottom:2rem; flex-wrap:wrap; }
    .card { flex:1; min-width:180px; background:#1e293b; border-radius:12px; padding:1.5rem; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.5); transition:transform 0.3s,box-shadow 0.3s; cursor:pointer; }
    .card:hover { transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.7); }
    .card h2 { font-size:2rem; margin:0; color:#38bdf8; }
    .card p { margin:0.5rem 0 0; font-size:1rem; color:#ccc; }
    .card.pass h2 { color:#22c55e; }
    .card.fail h2 { color:#ef4444; }
    .card.rate h2 { color:#1e90ff; }
    .card.sec h2 { color:#facc15; }

    .graphs { display:flex; flex-wrap:wrap; gap:2rem; margin-bottom:2rem; }
    .graph-box { flex:1; min-width:300px; background:#1e293b; border-radius:12px; padding:1.5rem; box-shadow:0 4px 15px rgba(0,0,0,0.5); display:flex; flex-direction:column; align-items:center; }
    .graph-box h3 { margin-bottom:1rem; }

    canvas { max-width:100%; height:280px !important; }

    table { width:100%; border-collapse:collapse; background:#1e293b; border-radius:12px; overflow:hidden; margin-top:2rem; }
    th, td { padding:0.8rem 1rem; border-bottom:1px solid #334155; text-align:left; }
    th { background:#0f172a; color:#38bdf8; }
    tr:hover { background:#334155; }

    .ai-summary-box { background: linear-gradient(145deg, #0f172a, #1e293b); padding: 2rem; border-radius: 28px; box-shadow: 0 5px 25px rgba(0,255,255,0.5), inset 0 0 12px #38bdf8; margin-top: 2rem; color: #e0f7fa; line-height: 1.9; border: 2px solid #00ffff; position: relative; overflow-y: auto; max-height: 300px; font-family: 'Courier New', monospace; font-size: 1.3rem; display:none; }
    .ai-summary-line { margin-bottom:0.7rem; }
    .blinking-cursor { display:inline-block; margin-left:2px; width:10px; animation: blink 1s step-end infinite; }
    @keyframes blink { from, to { opacity: 0; } 50% { opacity: 1; } }
    .ai-success { color:#22c55e; font-weight:bold; }
    .ai-warning { color:#facc15; font-weight:bold; }
    .ai-info { color:#38bdf8; font-weight:bold; }

    .bottom-buttons { display:flex; justify-content:center; gap:2rem; margin-top:2rem; margin-bottom:3rem; }
#popup {
    display: none;
    position: fixed;
    bottom: 20px;       
    right: -350px;      
    max-width: 380px;
    padding: 14px 20px;
    border-radius: 10px;
    font-weight: bold;
    color: #fff;
    background: #22c55e; 
    z-index: 9999;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    transition: right 0.4s ease, opacity 0.4s ease;
    font-family: 'Poppins', sans-serif;
    display: flex;
    align-items: center;
    gap: 8px;
}

#popup span.icon { font-size: 1.2rem; }
#popup.error { background: #ef4444; color: #fff; }
#popup.info { background: #f8fbfc; color: #0c0b0b; }
@keyframes slideIn { from { opacity: 0; transform: translate(-50%, 30px); } to { opacity: 1; transform: translate(-50%, 0); } }
  </style>
</head>
<body>

<header class="main-header">
  <div class="logo"><span class="site-title">SecureWebAudit</span></div>
  <nav class="nav-links">
    <a href="{{ url_for('home') }}">Home</a>
    <a href="{{ url_for('login') }}">Login</a>
    <a href="{{ url_for('help_page') }}">Help</a>
  </nav>
  <a href="{{ url_for('login') }}" class="login-btn">Login</a>
</header>

<div class="page-heading">Automation Test Dashboard</div>

<div class="container">
  <div class="summary">
    <div class="card" onclick="filterTable('all')"><h2 id="totalTests">0</h2><p>Total Tests</p></div>
       

       <div class="card fail" onclick="filterTable('security')"><h2 id="securityTests">0</h2><p>Security Failed</p></div>
        <div class="card pass" onclick="filterTable('fail')"><h2 id="securitypassedTests">0</h2><p>security passed</p></div>
    <div class="card pass" onclick="filterTable('pass')"><h2 id="passedTests">0</h2><p>functinal Passed</p></div>
    <div class="card fail" onclick="filterTable('fail')"><h2 id="failedTests">0</h2><p>functinal Failed</p></div>
   

    <div class="card rate"><h2 id="successRate">0%</h2><p>Success Rate</p></div>
 
  </div>

  <div class="graphs">
    <div class="graph-box">
      <h3>Selenium Pass/Fail Distribution</h3>
      <canvas id="seleniumDonut"></canvas>
    </div>
    <div class="graph-box">
      <h3>Security Pass/Fail Distribution</h3>
      <canvas id="securityBar"></canvas>
    </div>
    <div class="graph-box">
      <h3>Combined Results Overview</h3>
      <canvas id="combinedBar"></canvas>
    </div>
  </div>

 <h3>Detailed Report</h3>
<table>
  <thead>
    <tr>
      <th>Test</th>
      <th>Status</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody id="reportTable">
    <!-- Functional/Selenium tests first -->
    {% for test in test_results.details if test.get('type') in ['functional','selenium'] %}
      <tr data-status="{{ test.status }}">
        <td>{{ test.test }}</td>
        <td style="color:{{ '#22c55e' if test.status=='pass' else '#ef4444' }}; font-weight:bold;">
          {{ test.status }}
        </td>
        <td>{{ test.short_desc }}</td>
      </tr>
    {% endfor %}

    <!-- Security tests header row -->
    <tr style="background:#0f172a; text-align:center; font-weight:bold;">
      <td colspan="3">Security Test Results</td>
    </tr>

    <!-- Security tests -->
    {% for test in test_results.details if test.get('type') == 'security' %}
      <tr data-status="{{ test.status }}">
        <td>{{ test.test }}</td>
        <td style="color:{{ '#22c55e' if test.status=='pass' else '#ef4444' }}; font-weight:bold;">
          {{ test.status }}
        </td>
        <td>{{ test.short_desc }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<div id="ai-summary-box" class="ai-summary-box">
  <div id="ai-avatar" style="position:absolute; top:10px; left:10px; font-size:1.6rem;">ü§ñ</div>
  <div id="ai-text" style="margin-left:40px;"></div>
</div>

<div id="popup"></div>

<div class="bottom-buttons">
  <a href="#" class="btn" onclick="downloadReport(); return false;">‚¨á Download Report</a>
  <button class="btn" onclick="window.location.href='/input'">‚ûï Run New Test</button>
  <button class="btn" id="generate-ai-btn" onclick="generateAIReport()">ü§ñ Generate AI Report</button>
  <button class="btn" id="email-ai-btn" onclick="emailAIReport()">üìß Send AI Report to My Email</button>
</div>
</div>




<script>
const seleniumPass = {{ test_results.pass }};
const seleniumFail = {{ test_results.fail }};
const securityPass = {{ test_results.security.pass }};
const securityFail = {{ test_results.security.fail }};
const totalTests = seleniumPass + seleniumFail + securityPass + securityFail;
const successRate = totalTests > 0 ? ((seleniumPass , securityPass /totalTests)*100).toFixed(1) : 0;

document.getElementById("totalTests").innerText = totalTests;

document.getElementById("passedTests").innerText = seleniumPass;
document.getElementById("failedTests").innerText = seleniumFail;
document.getElementById("successRate").innerText = successRate + "%";
document.getElementById("securitypassedTests").innerText = securityPass;
document.getElementById("securityTests").innerText = securityFail;

// Graph 1: Selenium Donut
new Chart(document.getElementById("seleniumDonut"), {
    type:'doughnut',
    data:{labels:['Pass','Fail'],datasets:[{data:[seleniumPass, seleniumFail], backgroundColor:['#22c55e','#ef4444'], borderWidth:2}]},
    options:{responsive:true, maintainAspectRatio:false}
});

// Graph 2: Security Bar
new Chart(document.getElementById("securityBar"), {
    type:'bar',
    data:{labels:['Pass','Fail'],datasets:[{label:'Security Tests', data:[securityPass, securityFail], backgroundColor:['#facc15','#f87171'] }]},
    options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
});

// Graph 3: Combined Bar
new Chart(document.getElementById("combinedBar"), {
    type:'bar',
    data:{
        labels:['Selenium Pass','Selenium Fail','Security Pass','Security Fail','Total Tests'],
        datasets:[{label:'Total', data:[seleniumPass, seleniumFail, securityPass, securityFail, seleniumPass+seleniumFail+securityPass+securityFail], backgroundColor:['#22c55e','#ef4444','#facc15','#f87171','#38bdf8']}]
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
});

// Table filter
function filterTable(status){
  document.querySelectorAll("#reportTable tr").forEach(row=>{
    row.style.display=(status==='all'||row.dataset.status===status)?'':'none';
  });
}

// Download CSV
async function downloadReport(){
  let summaryData=await fetch("/get_summary");
  let summaryJson=await summaryData.json();
  let summary=summaryJson.summary;
  let csv="Test,Status,Description\n";
  {% for test in test_results.details %}csv+="{{ test.test }},{{ test.status }},{{ test.short_desc }}\n";{% endfor %}
  csv+="\nAI Summary,"+summary+"\n";
  let blob=new Blob([csv],{type:'text/csv'});
  let url=URL.createObjectURL(blob);
  let a=document.createElement('a');
  a.href=url;
  a.download="test_report.csv";
  a.click();
}

// AI Report typing
async function generateAIReport(){
  const aiBox = document.getElementById("ai-summary-box");
  const aiText = document.getElementById("ai-text");
  aiText.innerHTML = "";
  aiBox.style.display = "block";

  let dots = 0;
  aiText.innerHTML = "ü§ñ AI is analyzing your test results";
  const thinking = setInterval(()=>{
    dots = (dots + 1) % 4;
    aiText.innerHTML = "ü§ñ AI is analyzing your test results" + '.'.repeat(dots) + '<span class="blinking-cursor">|</span>';
  }, 400);

  const response = await fetch("/get_summary");
  const data = await response.json();
  clearInterval(thinking);

  const fullText = data.summary;
  let index = 0;
  function typeLetter(){
    if(index < fullText.length){
      aiText.innerHTML = fullText.slice(0,index+1)+'<span class="blinking-cursor">|</span>';
      index++;
      setTimeout(typeLetter,35);
    } else {
      aiText.innerHTML = fullText+'<span class="blinking-cursor">|</span>';
    }
  }
  typeLetter();
}

// Popup function
function showPopup(message, type="success"){
    const popup = document.getElementById("popup");
    popup.className = "";
    if(type==="success") popup.style.background="#22c55e";
    else if(type==="error") popup.style.background="#ef4444";
    else popup.style.background="#38bdf8";

    popup.innerHTML=`<span class="icon">${type==="success"?"‚úÖ":type==="error"?"‚ùå":"‚ÑπÔ∏è"}</span> ${message}`;
    
    popup.style.display="flex";
    setTimeout(()=>{ popup.style.right="20px"; popup.style.opacity=1; }, 10);

    if(popup.hideTimeout) clearTimeout(popup.hideTimeout);
    popup.hideTimeout = setTimeout(()=>{
        popup.style.right="-350px";
        popup.style.opacity=0;
        setTimeout(()=>{ popup.style.display="none"; },400);
    }, 5000);
}

// Email AI Report
async function emailAIReport(){
    const summaryBox = document.getElementById("ai-text").innerText.trim();
    if(!summaryBox){ showPopup("Generate AI report first!","error"); return; }
    showPopup("Sending report...","info");

    try{
        const response = await fetch("/send_ai_report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({report:summaryBox})});
        const data = await response.json();
        const type = data.status==="success"?"success":"error";
        showPopup(data.message,type);
    } catch(err){
        console.error(err);
        showPopup("Error sending report.","error");
    }
}
</script>
</body>
</html>
